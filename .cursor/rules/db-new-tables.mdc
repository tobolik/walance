---
description: Standardní logika pro nové DB tabulky – soft-update, valid_*, entity_id
globs: migrations/*.sql, schema*.sql, api/crud.php
alwaysApply: false
---

# Nové tabulky – soft-update logika

Při vytváření nových tabulek v tomto projektu **vždy** použij standardní soft-update logiku.

## POVINNÉ: soft* metody v crud.php

**Nikdy nepoužívat přímý INSERT/UPDATE/DELETE** pro tabulky s soft-update logikou. Vždy:
- **Přidání:** `softInsert($table, $data)` – automaticky doplní valid_from, valid_to, valid_user_from, valid_user_to, {tabulka}_id
- **Úprava:** `softUpdate($table, $id, $data)` – invaliduje starý řádek, vytvoří nový
- **Smazání:** `softDelete($table, $id)` – nastaví valid_to
- **Čtení:** `findActive()`, `findAllActive()` – filtruje WHERE valid_to IS NULL

Přímý INSERT bez softInsert = chybí bank_accounts_id, valid_user_from, valid_from atd.

## Sloupce v každé nové tabulce

1. **`{tabulka}_id`** (např. `bank_accounts_id`) – entity_id pro provázání verzí, INT UNSIGNED NULL, hned za `id`
2. **`valid_from`** – DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
3. **`valid_to`** – DATETIME NULL DEFAULT NULL
4. **`valid_user_from`** – INT UNSIGNED NULL
5. **`valid_user_to`** – INT UNSIGNED NULL

## Indexy

- `INDEX idx_{tabulka}_id ({tabulka}_id, valid_to)`
- `INDEX idx_v (valid_to)`

## API (crud.php)

- **Vždy** používat `softInsert`, `softUpdate`, `softDelete` – nikdy přímý INSERT/UPDATE/DELETE
- Používat `findActive`, `findAllActive` pro čtení (WHERE valid_to IS NULL)
- Přidat tabulku do `$FIELDS`, `$REQUIRED`, `$FIELD_LABELS`

## Příklad migrace

```sql
CREATE TABLE IF NOT EXISTS nova_tabulka (
    id               INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    nova_tabulka_id  INT UNSIGNED NULL,
    -- obchodní sloupce --
    valid_from       DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    valid_to         DATETIME NULL DEFAULT NULL,
    valid_user_from  INT UNSIGNED NULL,
    valid_user_to    INT UNSIGNED NULL,
    INDEX idx_nova_tabulka_id (nova_tabulka_id, valid_to),
    INDEX idx_v (valid_to)
) ENGINE=InnoDB;
```
